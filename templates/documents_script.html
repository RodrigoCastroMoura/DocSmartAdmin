let currentPage = 1;
const perPage = 10;
let totalPages = 1;

function getFileIcon(filename) {
    if (!filename) return 'file';
    
    const ext = filename.split('.').pop().toLowerCase();
    switch (ext) {
        case 'pdf': return 'file-text';
        case 'doc': case 'docx': return 'file-text';  // Changed from 'file-word'
        case 'xls': case 'xlsx': return 'file';
        case 'ppt': case 'pptx': return 'file';
        case 'txt': return 'file-text';
        case 'jpg': case 'jpeg': case 'png': case 'gif': case 'bmp': return 'image';
        case 'zip': case 'rar': case '7z': case 'tar': case 'gz': return 'archive';
        case 'mp3': case 'wav': case 'ogg': return 'music';
        case 'mp4': case 'avi': case 'mov': return 'video';
        default: return 'file';
    }
}

async function loadDocuments(page = 1) {
    currentPage = page;
    const contentDiv = document.getElementById('documentsContent');
    showLoading(contentDiv);

    try {
        // Get filter values
        const departmentId = document.getElementById('filterDepartment').value;
        const categoryId = document.getElementById('filterCategory').value;
        const documentTypeId = document.getElementById('filterDocumentType').value;
        const userId = document.getElementById('filterUser').value;

        // Build query params
        const params = new URLSearchParams({
            page: currentPage,
            per_page: perPage
        });

        if (departmentId) params.append('department_id', departmentId);
        if (categoryId) params.append('category_id', categoryId);
        if (documentTypeId) params.append('document_type_id', documentTypeId);
        if (userId) params.append('user_id', userId);

        const response = await fetch(`/api/documents?${params}`);
        const data = await response.json();
        
        totalPages = data.total_pages || 1;
        updateDocumentsGrid(data);
        updatePaginationControls();
    } catch (error) {
        console.error('Error loading documents:', error);
        showErrorMessage('Failed to load documents');
    } finally {
        hideLoading(contentDiv);
    }
}

async function loadFilterData() {
    try {
        // Load departments (already in select from server-side)
        
        // Load document types
        const typesResponse = await fetch('/api/document_types');
        if (typesResponse.ok) {
            const typesData = await typesResponse.json();
            const typeSelect = document.getElementById('filterDocumentType');
            typeSelect.innerHTML = '<option value="">All Types</option>' +
                typesData.document_types.map(type => 
                    `<option value="${type.id}">${type.name}</option>`
                ).join('');
        }

        // Load users
        const usersResponse = await fetch('/api/users');
        if (usersResponse.ok) {
            const usersData = await usersResponse.json();
            const userSelect = document.getElementById('filterUser');
            userSelect.innerHTML = '<option value="">All Users</option>' +
                usersData.users.map(user => 
                    `<option value="${user.id}">${user.name}</option>`
                ).join('');
        }
    } catch (error) {
        console.error('Error loading filter data:', error);
        showErrorMessage('Failed to load filter options');
    }
}

async function handleFilterChange() {
    const departmentId = document.getElementById('filterDepartment').value;
    const categorySelect = document.getElementById('filterCategory');

    // Clear and disable category select when no department is selected
    if (!departmentId) {
        categorySelect.innerHTML = '<option value="">All Categories</option>';
        categorySelect.disabled = true;
        return;
    }

    try {
        categorySelect.disabled = true;
        const response = await fetch(`/api/categories/departments/${departmentId}/categories`);
        if (response.ok) {
            const data = await response.json();
            categorySelect.innerHTML = '<option value="">All Categories</option>' +
                data.categories.map(cat => 
                    `<option value="${cat.id}">${cat.name}</option>`
                ).join('');
        }
    } catch (error) {
        console.error('Error loading categories:', error);
        showErrorMessage('Failed to load categories');
    } finally {
        categorySelect.disabled = false;
    }

    // Reload documents with new filter
    loadDocuments(1);
}

function clearFilters() {
    document.getElementById('filterDepartment').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterDocumentType').value = '';
    document.getElementById('filterUser').value = '';
    loadDocuments(1);
}

function updatePaginationControls() {
    document.getElementById('prevPage').disabled = currentPage <= 1;
    document.getElementById('nextPage').disabled = currentPage >= totalPages;
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
}

function changePage(newPage) {
    if (newPage >= 1 && newPage <= totalPages) {
        loadDocuments(newPage);
    }
}

function updateDocumentsGrid(data) {
    const documents = data.documents || [];
    const gridHTML = documents.length === 0 ? `
        <div class="documents-grid">
            <div class="no-data">
                <i data-feather="inbox"></i>
                <p>No documents found</p>
            </div>
        </div>` : `
        <div class="documents-grid">
            ${documents.map(doc => `
                <div class="document-card" data-id="${doc.id}">
                    <div class="document-header">
                        <i data-feather="${getFileIcon(doc.name)}"></i>
                        <div class="document-title">
                            <h3>${doc.document_type_name || 'No Type'}</h3>
                            <span class="document-filename">${doc.name}</span>
                        </div>
                    </div>
                    <div class="document-info">
                        <div class="document-user">
                            <div class="user-avatar">${doc.user_name ? doc.user_name.slice(0, 2).toUpperCase() : 'NA'}</div>
                            <div class="user-info">
                                <span class="user-name">${doc.user_name || 'No User'}</span>
                                <span class="user-cpf">${doc.user_cpf || 'No CPF'}</span>
                            </div>
                        </div>
                        <div class="document-meta">
                            <span><i data-feather="eye"></i> ${doc.view_count}</span>
                            <span><i data-feather="download"></i> ${doc.download_count}</span>
                            <span class="document-date">Created: ${new Date(doc.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="document-actions">
                        <button class="action-btn" onclick="previewDocument('${doc.id}', '${doc.url}')">
                            <i data-feather="eye"></i>
                        </button>
                        <button class="action-btn" onclick="downloadDocument('${doc.id}', '${doc.url}')">
                            <i data-feather="download"></i>
                        </button>
                        <button class="action-btn danger" onclick="deleteDocument('${doc.id}')">
                            <i data-feather="trash-2"></i>
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>`;

    const contentDiv = document.getElementById('documentsContent');
    const paginationControls = contentDiv.querySelector('.pagination-controls');
    contentDiv.innerHTML = gridHTML;
    contentDiv.appendChild(paginationControls);
    feather.replace();
}

// Initialize documents list and filters when page loads
document.addEventListener('DOMContentLoaded', () => {
    loadDocuments();
    loadFilterData();
});
