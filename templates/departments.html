{% extends "base.html" %}

{% block content %}
<div class="page-container">
    <div class="header-actions">
        <h2><i data-feather="briefcase"></i> Departments</h2>
        <button class="action-btn primary" onclick="showAddDepartmentModal()">
            <i data-feather="plus"></i> Add Department
        </button>
    </div>
    <div class="content-grid" id="departmentsContent">
        <div class="departments-grid">
            <div class="no-data">
                <i data-feather="inbox"></i>
                <p>Loading departments...</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Department Modal -->
<div id="addDepartmentModal" class="modal">
    <div class="modal-content">
        <h3>Add Department</h3>
        <form id="addDepartmentForm" onsubmit="createDepartment(event)">
            <div class="form-group">
                <label for="departmentName">Department Name</label>
                <input type="text" id="departmentName" name="name" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn" onclick="hideModal('addDepartmentModal')">Cancel</button>
                <button type="submit" class="action-btn primary">Add</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Department Modal -->
<div id="editDepartmentModal" class="modal">
    <div class="modal-content">
        <h3>Edit Department</h3>
        <form id="editDepartmentForm" onsubmit="updateDepartment(event)">
            <input type="hidden" id="editDepartmentId">
            <div class="form-group">
                <label for="editDepartmentName">Department Name</label>
                <input type="text" id="editDepartmentName" name="name" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn" onclick="hideModal('editDepartmentModal')">Cancel</button>
                <button type="submit" class="action-btn primary">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content notification-modal">
        <div class="notification-header">
            <i data-feather="alert-triangle" style="color: var(--danger-color);"></i>
            <h3>Confirm Delete</h3>
            <button class="close-btn" onclick="hideModal('deleteConfirmModal')">
                <i data-feather="x"></i>
            </button>
        </div>
        <div class="notification-body">
            <p>Are you sure you want to delete this item?</p>
            <p>This action cannot be undone.</p>
        </div>
        <div class="notification-actions">
            <button class="action-btn" onclick="hideModal('deleteConfirmModal')">Cancel</button>
            <button class="action-btn danger" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<script>
setupFormValidation('addDepartmentForm', {
    'departmentName': [
        ValidationRules.required,
        ValidationRules.minLength(3),
        ValidationRules.maxLength(50)
    ]
});

setupFormValidation('editDepartmentForm', {
    'editDepartmentName': [
        ValidationRules.required,
        ValidationRules.minLength(3),
        ValidationRules.maxLength(50)
    ]
});

let itemToDelete = null;

function showDeleteConfirmation(id) {
    itemToDelete = id;
    showModal('deleteConfirmModal');
    feather.replace();
}

async function confirmDelete() {
    if (!itemToDelete) return;
    
    const id = itemToDelete;
    hideModal('deleteConfirmModal');
    const card = document.querySelector(`.department-card[data-id="${id}"]`);
    showLoading(card);

    try {
        const response = await fetch(`/api/departments/${id}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            let errorMessage = 'Failed to delete department';
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorData.message || 'Failed to delete department';
            } catch (e) {
                console.error('Error parsing error response:', e);
            }
            throw new Error(errorMessage);
        }

        await loadDepartments();
        showNotification('Department deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting department:', error.message || 'Unknown error');
        showNotification(error.message || 'Failed to delete department', 'error');
    } finally {
        hideLoading(card);
        itemToDelete = null;
    }
}

// Rest of the original script remained the same, including other functions like loadDepartments, etc.

function deleteDepartment(id) {
    showDeleteConfirmation(id);
}

function showModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function hideModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showAddDepartmentModal() {
    document.getElementById('addDepartmentForm').reset();
    showModal('addDepartmentModal');
}

function showEditDepartmentModal(id, name) {
    document.getElementById('editDepartmentId').value = id;
    document.getElementById('editDepartmentName').value = name;
    showModal('editDepartmentModal');
}

// Initialize departments list when page loads
document.addEventListener('DOMContentLoaded', loadDepartments);
</script>

<style>
/* Original style remained the same */
</style>
{% endblock %}