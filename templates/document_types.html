{% extends "base.html" %}

{% block content %}
<div class="page-container">
    <div class="header-actions">
        <h2><i data-feather="file"></i> Document Types</h2>
        <button class="action-btn primary" onclick="showAddDocumentTypeModal()">
            <i data-feather="plus"></i> Add Document Type
        </button>
    </div>
    <div class="content-grid" id="documentTypesContent">
        <div class="document-types-grid">
            <div class="no-data">
                <i data-feather="inbox"></i>
                <p>Loading document types...</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Document Type Modal -->
<div id="addDocumentTypeModal" class="modal">
    <div class="modal-content">
        <h3>Add Document Type</h3>
        <form id="addDocumentTypeForm" onsubmit="createDocumentType(event)">
            <div class="form-group">
                <label for="documentTypeName">Name</label>
                <input type="text" id="documentTypeName" name="name" required>
            </div>
            <div class="form-group">
                <label for="documentTypeDescription">Description</label>
                <input type="text" id="documentTypeDescription" name="description">
            </div>
            <div class="form-group">
                <label for="documentTypeDepartment">Department</label>
                <select id="documentTypeDepartment" onchange="loadDepartmentCategories(this.value)">
                    <option value="">Select Department</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="documentTypeCategory">Category</label>
                <select id="documentTypeCategory" name="category_id" required>
                    <option value="">Select Category</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn" onclick="hideModal('addDocumentTypeModal')">Cancel</button>
                <button type="submit" class="action-btn primary">Add</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Document Type Modal -->
<div id="editDocumentTypeModal" class="modal">
    <div class="modal-content">
        <h3>Edit Document Type</h3>
        <form id="editDocumentTypeForm" onsubmit="updateDocumentType(event)">
            <input type="hidden" id="editDocumentTypeId">
            <div class="form-group">
                <label for="editDocumentTypeName">Name</label>
                <input type="text" id="editDocumentTypeName" name="name" required>
            </div>
            <div class="form-group">
                <label for="editDocumentTypeDescription">Description</label>
                <input type="text" id="editDocumentTypeDescription" name="description">
            </div>
            <div class="form-group">
                <label for="editDocumentTypeDepartment">Department</label>
                <select id="editDocumentTypeDepartment" onchange="loadDepartmentCategories(this.value, 'editDocumentTypeCategory')">
                    <option value="">Select Department</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="editDocumentTypeCategory">Category</label>
                <select id="editDocumentTypeCategory" name="category_id" required>
                    <option value="">Select Category</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn" onclick="hideModal('editDocumentTypeModal')">Cancel</button>
                <button type="submit" class="action-btn primary">Update</button>
            </div>
        </form>
    </div>
</div>

<script>
// Global function definitions
(function(window) {
    window.showAddDocumentTypeModal = function() {
        document.getElementById('addDocumentTypeForm').reset();
        loadDepartments();
        showModal('addDocumentTypeModal');
    };

    window.showEditDocumentTypeModal = function(id, type) {
        document.getElementById('editDocumentTypeId').value = id;
        document.getElementById('editDocumentTypeName').value = type.name;
        document.getElementById('editDocumentTypeDescription').value = type.description || '';
        
        loadDepartments().then(function() {
            if (type.department_id) {
                document.getElementById('editDocumentTypeDepartment').value = type.department_id;
                loadDepartmentCategories(type.department_id, 'editDocumentTypeCategory').then(function() {
                    document.getElementById('editDocumentTypeCategory').value = type.category_id || '';
                });
            }
        });
        
        showModal('editDocumentTypeModal');
    };

    window.showModal = function(modalId) {
        document.getElementById(modalId).style.display = 'block';
    };

    window.hideModal = function(modalId) {
        document.getElementById(modalId).style.display = 'none';
    };

    window.loadDepartmentCategories = function(departmentId, targetSelectId) {
        targetSelectId = targetSelectId || 'documentTypeCategory';
        if (!departmentId) return;
        
        var categorySelect = document.getElementById(targetSelectId);
        categorySelect.innerHTML = '<option value="">Loading categories...</option>';
        categorySelect.disabled = true;

        fetch('/api/categories/departments/' + departmentId + '/categories')
            .then(function(response) {
                if (!response.ok) throw new Error('Failed to load categories');
                return response.json();
            })
            .then(function(data) {
                categorySelect.innerHTML = '<option value="">Select Category</option>' +
                    (data.categories || []).map(function(cat) {
                        return '<option value="' + cat.id + '">' + cat.name + '</option>';
                    }).join('');
            })
            .catch(function(error) {
                console.error('Error loading categories:', error);
                categorySelect.innerHTML = '<option value="">Error loading categories</option>';
                showErrorMessage('Failed to load categories');
            })
            .finally(function() {
                categorySelect.disabled = false;
            });
    };

    window.loadDocumentTypes = function() {
        var contentDiv = document.getElementById('documentTypesContent');
        showLoading(contentDiv);

        fetch('/api/document_types')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                if (!data || !data.types) {
                    throw new Error('Invalid response format');
                }
                contentDiv.innerHTML = generateDocumentTypesHTML(data.types);
                feather.replace();
            })
            .catch(function(error) {
                console.error('Error loading document types:', error);
                contentDiv.innerHTML = '<div class="document-types-grid"><div class="no-data">' +
                    '<i data-feather="alert-circle"></i>' +
                    '<p>' + (error.message || 'Failed to load document types') + '</p></div></div>';
                feather.replace();
            })
            .finally(function() {
                hideLoading(contentDiv);
            });
    };

    window.createDocumentType = function(event) {
        event.preventDefault();
        var form = event.target;
        var submitButton = form.querySelector('button[type="submit"]');
        
        if (!validateForm(form)) {
            return;
        }
        
        var formData = new FormData(form);
        var data = Object.fromEntries(formData);
        showLoading(submitButton);

        fetch('/api/document_types', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: data.name,
                description: data.description || '',
                category_id: data.category_id
            })
        })
        .then(function(response) {
            return response.json().then(function(data) {
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create document type');
                }
                return data;
            });
        })
        .then(function() {
            hideModal('addDocumentTypeModal');
            form.reset();
            return loadDocumentTypes();
        })
        .then(function() {
            showErrorMessage('Document type created successfully', 'success');
        })
        .catch(function(error) {
            console.error('Error creating document type:', error);
            showErrorMessage(error.message);
        })
        .finally(function() {
            hideLoading(submitButton);
        });
    };

    window.updateDocumentType = function(event) {
        event.preventDefault();
        var form = event.target;
        var submitButton = form.querySelector('button[type="submit"]');
        
        if (!validateForm(form)) {
            return;
        }
        
        var id = document.getElementById('editDocumentTypeId').value;
        var formData = new FormData(form);
        var data = Object.fromEntries(formData);
        showLoading(submitButton);

        fetch('/api/document_types/' + id, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: data.name,
                description: data.description || '',
                category_id: data.category_id
            })
        })
        .then(function(response) {
            return response.json().then(function(data) {
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to update document type');
                }
                return data;
            });
        })
        .then(function() {
            hideModal('editDocumentTypeModal');
            return loadDocumentTypes();
        })
        .then(function() {
            showErrorMessage('Document type updated successfully', 'success');
        })
        .catch(function(error) {
            console.error('Error updating document type:', error);
            showErrorMessage(error.message);
        })
        .finally(function() {
            hideLoading(submitButton);
        });
    };

    window.deleteDocumentType = function(id) {
        if (!confirm('Are you sure you want to delete this document type?')) {
            return;
        }

        var card = document.querySelector('.document-type-card[data-id="' + id + '"]');
        showLoading(card);

        fetch('/api/document_types/' + id, {
            method: 'DELETE'
        })
        .then(function(response) {
            if (!response.ok) {
                return response.json().then(function(data) {
                    throw new Error(data.error || 'Failed to delete document type');
                });
            }
        })
        .then(function() {
            return loadDocumentTypes();
        })
        .then(function() {
            showErrorMessage('Document type deleted successfully', 'success');
        })
        .catch(function(error) {
            console.error('Error deleting document type:', error);
            showErrorMessage(error.message);
        })
        .finally(function() {
            hideLoading(card);
        });
    };

    // Helper functions
    function generateDocumentTypesHTML(types) {
        if (!types || !types.length) {
            return '<div class="document-types-grid"><div class="no-data">' +
                '<i data-feather="inbox"></i><p>No document types found</p></div></div>';
        }

        var typesHTML = types.map(function(type) {
            return '<div class="document-type-card" data-id="' + type.id + '">' +
                '<div class="document-type-header">' +
                '<i data-feather="file"></i>' +
                '<h3>' + type.name + '</h3>' +
                '</div>' +
                '<div class="document-type-info">' +
                '<p>' + (type.description || 'No description') + '</p>' +
                '<div class="category-badge">' +
                '<i data-feather="grid"></i>' +
                '<span>Category: ' + (type.category_name || 'None') + '</span>' +
                '</div>' +
                '</div>' +
                '<div class="document-type-actions">' +
                '<button class="action-btn" onclick=\'showEditDocumentTypeModal("' + type.id + '", ' + JSON.stringify(type) + ')\'>' +
                '<i data-feather="edit-2"></i>' +
                '</button>' +
                '<button class="action-btn danger" onclick="deleteDocumentType(\'' + type.id + '\')">' +
                '<i data-feather="trash-2"></i>' +
                '</button>' +
                '</div>' +
                '</div>';
        }).join('');

        return '<div class="document-types-grid">' + typesHTML + '</div>';
    }

    function loadDepartments() {
        var departmentSelect = document.getElementById('documentTypeDepartment');
        var editDepartmentSelect = document.getElementById('editDocumentTypeDepartment');
        
        return fetch('/api/departments')
            .then(function(response) {
                if (!response.ok) throw new Error('Failed to load departments');
                return response.json();
            })
            .then(function(data) {
                var departmentsHTML = '<option value="">Select Department</option>' +
                    data.map(function(dept) {
                        return '<option value="' + dept.id + '">' + dept.name + '</option>';
                    }).join('');
                    
                departmentSelect.innerHTML = departmentsHTML;
                editDepartmentSelect.innerHTML = departmentsHTML;
            })
            .catch(function(error) {
                console.error('Error loading departments:', error);
                showErrorMessage('Failed to load departments');
            });
    }

    // Initialize document types list when page loads
    document.addEventListener('DOMContentLoaded', loadDocumentTypes);

})(window);
</script>

<style>
.document-types-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
}

.document-type-card {
    background-color: var(--bg-tertiary);
    border-radius: 8px;
    padding: 1.5rem;
    transition: transform 0.2s;
}

.document-type-card:hover {
    transform: translateY(-2px);
}

.document-type-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.document-type-header i {
    padding: 0.75rem;
    background-color: var(--accent-color);
    border-radius: 6px;
}

.document-type-info {
    margin: 1rem 0;
}

.category-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background-color: var(--bg-secondary);
    border-radius: 4px;
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

.document-type-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 1rem;
}

.page-container {
    padding: 2rem;
}

.header-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-actions h2 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.content-grid {
    background-color: var(--bg-secondary);
    border-radius: 8px;
    padding: 1.5rem;
}
</style>
{% endblock %}
