{% extends "base.html" %}

{% block content %}
<div class="page-container">
    <div class="header-actions">
        <h2><i data-feather="file"></i> Tipos de Documentos</h2>
        <button class="action-btn primary" onclick="showAddDocumentTypeModal()">
            <i data-feather="plus"></i> Adicionar Tipo de Documento
        </button>
    </div>
    <div class="content-grid" id="documentTypesContent">
        <div class="document-types-grid">
            <div class="no-data">
                <i data-feather="inbox"></i>
                <p>Carregando tipos de documentos...</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Document Type Modal -->
<div id="addDocumentTypeModal" class="modal">
    <div class="modal-content">
        <h3>Adicionar Tipo de Documento</h3>
        <form id="addDocumentTypeForm" onsubmit="createDocumentType(event)">
            <div class="form-group">
                <label for="documentTypeName">Nome</label>
                <input type="text" id="documentTypeName" name="name" required>
            </div>
            <div class="form-group">
                <label for="documentTypeDescription">Descrição</label>
                <input type="text" id="documentTypeDescription" name="description">
            </div>
            <div class="form-group">
                <label for="documentTypeDepartment">Departamento</label>
                <select id="documentTypeDepartment" onchange="loadDepartmentCategories(this.value)">
                    <option value="">Selecionar Departamento</option>
                </select>
            </div>
            <div class="form-group">
                <label for="documentTypeCategory">Categoria</label>
                <select id="documentTypeCategory" name="category_id" required>
                    <option value="">Selecionar Categoria</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn" onclick="hideModal('addDocumentTypeModal')">Cancelar</button>
                <button type="submit" class="action-btn primary">Adicionar</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Document Type Modal -->
<div id="editDocumentTypeModal" class="modal">
    <div class="modal-content">
        <h3>Editar Tipo de Documento</h3>
        <form id="editDocumentTypeForm" onsubmit="updateDocumentType(event)">
            <input type="hidden" id="editDocumentTypeId">
            <div class="form-group">
                <label for="editDocumentTypeName">Nome</label>
                <input type="text" id="editDocumentTypeName" name="name" required>
            </div>
            <div class="form-group">
                <label for="editDocumentTypeDescription">Descrição</label>
                <input type="text" id="editDocumentTypeDescription" name="description">
            </div>
            <div class="form-group">
                <label for="editDocumentTypeDepartment">Departamento</label>
                <select id="editDocumentTypeDepartment" onchange="loadDepartmentCategories(this.value, 'editDocumentTypeCategory')">
                    <option value="">Selecionar Departamento</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editDocumentTypeCategory">Categoria</label>
                <select id="editDocumentTypeCategory" name="category_id" required>
                    <option value="">Selecionar Categoria</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn" onclick="hideModal('editDocumentTypeModal')">Cancelar</button>
                <button type="submit" class="action-btn primary">Atualizar</button>
            </div>
        </form>
    </div>
</div>

<script>
setupFormValidation('addDocumentTypeForm', {
    'documentTypeName': [
        ValidationRules.required,
        ValidationRules.minLength(3),
        ValidationRules.maxLength(50)
    ],
    'documentTypeCategory': [
        ValidationRules.required
    ]
});

setupFormValidation('editDocumentTypeForm', {
    'editDocumentTypeName': [
        ValidationRules.required,
        ValidationRules.minLength(3),
        ValidationRules.maxLength(50)
    ],
    'editDocumentTypeCategory': [
        ValidationRules.required
    ]
});

async function loadDepartments() {
    const departmentSelects = [
        document.getElementById('documentTypeDepartment'),
        document.getElementById('editDocumentTypeDepartment')
    ];

    try {
        const response = await fetch('/api/departments');
        if (!response.ok) throw new Error('Falha ao carregar departamentos');
        const data = await response.json();

        const departmentsOptions = `
            <option value="">Selecionar Departamento</option>
            ${data.map(dept => 
                `<option value="${dept.id}">${dept.name}</option>`
            ).join('')}`;

        departmentSelects.forEach(select => {
            if (select) select.innerHTML = departmentsOptions;
        });
    } catch (error) {
        console.error('Erro ao carregar departamentos:', error);
        departmentSelects.forEach(select => {
            if (select) select.innerHTML = '<option value="">Erro ao carregar departamentos</option>';
        });
    }
}

async function loadDepartmentCategories(departmentId, targetId = 'documentTypeCategory') {
    const categorySelect = document.getElementById(targetId);
    categorySelect.innerHTML = '<option value="">Carregando categorias...</option>';
    categorySelect.disabled = true;

    try {
        const response = await fetch(`/api/categories/departments/${departmentId}/categories`);
        if (!response.ok) throw new Error('Falha ao carregar categorias');
        const data = await response.json();

        categorySelect.innerHTML = `
            <option value="">Selecionar Categoria</option>
            ${data.categories.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('')}`;
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
        categorySelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
    } finally {
        categorySelect.disabled = false;
    }
}

async function loadDocumentTypes() {
    const contentDiv = document.getElementById('documentTypesContent');
    showLoading(contentDiv);

    try {
        const response = await fetch('/api/document_types');
        if (!response.ok) {
            throw new Error(`Erro HTTP! status: ${response.status}`);
        }

        const data = await response.json();
        if (!data || !data.document_types) {
            throw new Error('Formato de resposta inválido');
        }

        contentDiv.innerHTML = generateDocumentTypesHTML(data.document_types);
        feather.replace();
    } catch (error) {
        console.error('Erro ao carregar tipos de documentos:', error);
        contentDiv.innerHTML = `
            <div class="document-types-grid">
                <div class="no-data">
                    <i data-feather="alert-circle"></i>
                    <p>${error.message || 'Falha ao carregar tipos de documentos'}</p>
                </div>
            </div>`;
        feather.replace();
    } finally {
        hideLoading(contentDiv);
    }
}

function generateDocumentTypesHTML(types) {
    if (!Array.isArray(types) || types.length === 0) {
        return `
            <div class="document-types-grid">
                <div class="no-data">
                    <i data-feather="inbox"></i>
                    <p>Nenhum tipo de documento encontrado</p>
                </div>
            </div>`;
    }

    const typesHTML = types.map(type => `
        <div class="document-type-card" data-id="${type.id}">
            <div class="document-type-header">
                <i data-feather="file"></i>
                <a href="/document_type/${type.id}/documents" class="document-type-link">
                    <h3>${type.name}</h3>
                </a>   
            </div>
            <div class="document-type-info">
                <p class="description">${type.description || 'Sem descrição'}</p>
                <p class="meta">
                    <span>Documentos: ${type.document_count || 0}</span>
                    <span>Criado em: ${new Date(type.created_at).toLocaleDateString()}</span>
                </p>
            </div>
            <div class="document-type-actions">
                <button class="action-btn" onclick='showEditDocumentTypeModal("${type.id}", ${JSON.stringify(type)})'>
                    <i data-feather="edit-2"></i>
                </button>
                <button class="action-btn danger" onclick="deleteDocumentType('${type.id}')">
                    <i data-feather="trash-2"></i>
                </button>
            </div>
        </div>
    `).join('');

    return `<div class="document-types-grid">${typesHTML}</div>`;
}

async function createDocumentType(event) {
    event.preventDefault();
    const form = event.target;
    const submitButton = form.querySelector('button[type="submit"]');

    if (!validateForm(form)) {
        return;
    }

    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    showLoading(submitButton);

    try {
        const response = await fetch('/api/document_types', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Falha ao criar tipo de documento');
        }

        hideModal('addDocumentTypeModal');
        form.reset();
        await loadDocumentTypes();
        showNotification('Tipo de documento criado com sucesso', 'success');
    } catch (error) {
        console.error('Erro ao criar tipo de documento:', error);
        showErrorMessage(error.message);
    } finally {
        hideLoading(submitButton);
    }
}

async function updateDocumentType(event) {
    event.preventDefault();
    const form = event.target;
    const submitButton = form.querySelector('button[type="submit"]');

    if (!validateForm(form)) {
        return;
    }

    const id = document.getElementById('editDocumentTypeId').value;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    showLoading(submitButton);

    try {
        const response = await fetch(`/api/document_types/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Falha ao atualizar tipo de documento');
        }

        hideModal('editDocumentTypeModal');
        await loadDocumentTypes();
        showNotification('Tipo de documento atualizado com sucesso', 'success');
    } catch (error) {
        console.error('Erro ao atualizar tipo de documento:', error);
        showErrorMessage(error.message);
    } finally {
        hideLoading(submitButton);
    }
}

let itemToDelete = null;

async function confirmDelete() { 
    if (!itemToDelete) return;

    const id = itemToDelete;
    hideModal('deleteConfirmModal');
    const card = document.querySelector(`.document-type-card[data-id="${id}"]`);
    showLoading(card);

    try {
        const response = await fetch(`/api/document_types/${id}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Falha ao excluir tipo de documento');
        }

        await loadDocumentTypes();
        showNotification('Tipo de documento excluído com sucesso', 'success');
    } catch (error) {
        console.error('Erro ao excluir tipo de documento:', error);
        showErrorMessage(error.message);
    } finally {
        hideLoading(card);
    }
}

function deleteDocumentType(id) {
    showDeleteConfirmation(id);
}

function showDeleteConfirmation(id) {
    itemToDelete = id;
    showModal('deleteConfirmModal');
    feather.replace();
}

function showModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function hideModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showAddDocumentTypeModal() {
    document.getElementById('addDocumentTypeForm').reset();
    loadDepartments();
    showModal('addDocumentTypeModal');
}

function showEditDocumentTypeModal(id, type) {
    document.getElementById('editDocumentTypeId').value = id;
    document.getElementById('editDocumentTypeName').value = type.name;
    document.getElementById('editDocumentTypeDescription').value = type.description || '';
    loadDepartments().then(() => {
        if (type.department_id) {
            document.getElementById('editDocumentTypeDepartment').value = type.department_id;
            loadDepartmentCategories(type.department_id, 'editDocumentTypeCategory').then(() => {
                document.getElementById('editDocumentTypeCategory').value = type.category_id || '';
            });
        }
    });
    showModal('editDocumentTypeModal');
}

// Initialize document types list when page loads
document.addEventListener('DOMContentLoaded', loadDocumentTypes);
</script>

<style>
.document-types-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
}

.document-type-card {
    background-color: var(--bg-tertiary);
    border-radius: 8px;
    padding: 1.5rem;
    transition: transform 0.2s;
}

.document-type-card:hover {
    transform: translateY(-2px);
}

.document-type-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.document-type-header i {
    padding: 0.75rem;
    background-color: var(--accent-color);
    border-radius: 6px;
}

.document-type-info {
    margin: 1rem 0;
    color: var(--text-secondary);
}

.document-type-info .description {
    margin-bottom: 0.5rem;
    font-style: italic;
}

.document-type-info .meta {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
}

.document-type-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 1rem;
}

.page-container {
    padding: 2rem;
}

.header-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-actions h2 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.content-grid {
    background-color: var(--bg-secondary);
    border-radius: 8px;
    padding: 1.5rem;
}

.no-data {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}

.no-data i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}
.document-type-link {
    text-decoration: none;
    color: var(--text-primary);
}

.document-type-link:hover h3 {
    color: var(--accent-color);
}

</style>
{% endblock %}