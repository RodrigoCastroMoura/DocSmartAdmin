{% extends "base.html" %}

{% block content %}
<div class="page-container">
    <div class="header-actions">
        <h2><i data-feather="file"></i> Document Types</h2>
        <button class="action-btn primary" onclick="showAddDocumentTypeModal()">
            <i data-feather="plus"></i> Add Document Type
        </button>
    </div>
    <div class="content-grid" id="documentTypesContent">
        <div class="document-types-grid">
            <div class="no-data">
                <i data-feather="inbox"></i>
                <p>Loading document types...</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Document Type Modal -->
<div id="addDocumentTypeModal" class="modal">
    <div class="modal-content">
        <h3>Add Document Type</h3>
        <form id="addDocumentTypeForm" onsubmit="createDocumentType(event)">
            <div class="form-group">
                <label for="documentTypeName">Name</label>
                <input type="text" id="documentTypeName" name="name" required>
            </div>
            <div class="form-group">
                <label for="documentTypeDescription">Description</label>
                <input type="text" id="documentTypeDescription" name="description">
            </div>
            <div class="form-group">
                <label for="documentTypeDepartment">Department</label>
                <select id="documentTypeDepartment" onchange="loadDepartmentCategories(this.value)">
                    <option value="">Select Department</option>
                </select>
            </div>
            <div class="form-group">
                <label for="documentTypeCategory">Category</label>
                <select id="documentTypeCategory" name="category_id" required>
                    <option value="">Select Category</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn" onclick="hideModal('addDocumentTypeModal')">Cancel</button>
                <button type="submit" class="action-btn primary">Add</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Document Type Modal -->
<div id="editDocumentTypeModal" class="modal">
    <div class="modal-content">
        <h3>Edit Document Type</h3>
        <form id="editDocumentTypeForm" onsubmit="updateDocumentType(event)">
            <input type="hidden" id="editDocumentTypeId">
            <div class="form-group">
                <label for="editDocumentTypeName">Name</label>
                <input type="text" id="editDocumentTypeName" name="name" required>
            </div>
            <div class="form-group">
                <label for="editDocumentTypeDescription">Description</label>
                <input type="text" id="editDocumentTypeDescription" name="description">
            </div>
            <div class="form-group">
                <label for="editDocumentTypeDepartment">Department</label>
                <select id="editDocumentTypeDepartment" onchange="loadDepartmentCategories(this.value, 'editDocumentTypeCategory')">
                    <option value="">Select Department</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editDocumentTypeCategory">Category</label>
                <select id="editDocumentTypeCategory" name="category_id" required>
                    <option value="">Select Category</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn" onclick="hideModal('editDocumentTypeModal')">Cancel</button>
                <button type="submit" class="action-btn primary">Update</button>
            </div>
        </form>
    </div>
</div>

<script>
setupFormValidation('addDocumentTypeForm', {
    'documentTypeName': [
        ValidationRules.required,
        ValidationRules.minLength(3),
        ValidationRules.maxLength(50)
    ],
    'documentTypeCategory': [
        ValidationRules.required
    ]
});

setupFormValidation('editDocumentTypeForm', {
    'editDocumentTypeName': [
        ValidationRules.required,
        ValidationRules.minLength(3),
        ValidationRules.maxLength(50)
    ],
    'editDocumentTypeCategory': [
        ValidationRules.required
    ]
});

async function loadDepartments() {
    const departmentSelects = [
        document.getElementById('documentTypeDepartment'),
        document.getElementById('editDocumentTypeDepartment')
    ];
    
    try {
        const response = await fetch('/api/departments');
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Failed to load departments (${response.status})`);
        }
        const data = await response.json();
        
        if (!Array.isArray(data)) {
            throw new Error('Invalid response format: expected an array');
        }
        
        const departmentsOptions = `
            <option value="">Select Department</option>
            ${data.map(dept => 
                `<option value="${dept.id}">${dept.name}</option>`
            ).join('')}`;
            
        departmentSelects.forEach(select => {
            if (select) select.innerHTML = departmentsOptions;
        });
    } catch (error) {
        console.error('Error loading departments:', error);
        const errorMessage = error.message || 'Error loading departments';
        departmentSelects.forEach(select => {
            if (select) select.innerHTML = `<option value="">${errorMessage}</option>`;
        });
        showNotification(errorMessage, 'error');
    }
}

async function loadDepartmentCategories(departmentId, targetId = 'documentTypeCategory') {
    const categorySelect = document.getElementById(targetId);
    if (!departmentId) {
        categorySelect.innerHTML = '<option value="">Select Department first</option>';
        categorySelect.disabled = true;
        return;
    }
    
    categorySelect.innerHTML = '<option value="">Loading categories...</option>';
    categorySelect.disabled = true;

    try {
        const response = await fetch(`/api/categories/departments/${departmentId}/categories`);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Failed to load categories (${response.status})`);
        }
        
        const data = await response.json();
        if (!data || !data.categories) {
            throw new Error('Invalid response format');
        }
        
        if (data.categories.length === 0) {
            categorySelect.innerHTML = '<option value="">No categories found</option>';
            showNotification('No categories found for this department', 'error');
            return;
        }
        
        categorySelect.innerHTML = `
            <option value="">Select Category</option>
            ${data.categories.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('')}`;
    } catch (error) {
        console.error('Error loading categories:', error);
        const errorMessage = error.message || 'Failed to load categories';
        categorySelect.innerHTML = `<option value="">${errorMessage}</option>`;
        showNotification(errorMessage, 'error');
    } finally {
        categorySelect.disabled = false;
    }
}

async function loadDocumentTypes() {
    const contentDiv = document.getElementById('documentTypesContent');
    showLoading(contentDiv);

    try {
        const response = await fetch('/api/document_types');
        if (!response.ok) {
            let errorMessage = 'Failed to load document types';
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorData.message || 'Failed to load document types';
            } catch (e) {
                console.error('Error parsing error response:', e);
            }
            throw new Error(errorMessage);
        }
        
        const data = await response.json();
        if (!data || !data.document_types) {
            throw new Error('Invalid response format');
        }

        contentDiv.innerHTML = generateDocumentTypesHTML(data.document_types);
        feather.replace();
    } catch (error) {
        console.error('Error loading document types:', error.message || 'Unknown error');
        contentDiv.innerHTML = `
            <div class="document-types-grid">
                <div class="no-data error">
                    <i data-feather="alert-circle"></i>
                    <p>${error.message || 'Failed to load document types'}</p>
                    <button class="action-btn" onclick="loadDocumentTypes()">
                        <i data-feather="refresh-cw"></i> Retry
                    </button>
                </div>
            </div>`;
        feather.replace();
        showNotification(error.message || 'Failed to load document types', 'error');
    } finally {
        hideLoading(contentDiv);
    }
}

// Remaining functions (generateDocumentTypesHTML, createDocumentType, updateDocumentType, deleteDocumentType, etc.) 
// remain exactly the same as in the original code

// Initialize document types list when page loads
document.addEventListener('DOMContentLoaded', loadDocumentTypes);
</script>

<!-- Style and other sections remain the same as in the original code -->

{% endblock %}